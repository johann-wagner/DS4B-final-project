---
title: "Data Cleaning"
author: "Johann Wagner - u6958957"
date: "`r Sys.Date()`"
output:  
    html_document:
        toc: true
        toc_depth: 6
        theme: cosmo
        number_sections: false
        toc_float: true
        highlight: pygments
        fig_width: 10
        fig_height: 6
        df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

# Word/figure count

Words: [The number of words in your document, calculated using the word_count() function at the end of this document]
Figures: [The number of figures in your document. You can just count these]

# Locations on GitHub

-   The RMarkdown file that produced this HTML document can be found here: [data_cleaning.Rmd](https://github.com/johann-wagner/DS4B-final-project/blob/main/processed_data/data_cleaning.Rmd).

# Data Cleaning

The purpose of this .Rmd file is to search and take note/keep a log of any dodgy data points.

## **Package Loading**

If you are unfamiliar with some of these packages, I've left some short code comments for you to find more information. 

```{r Package-Loading, warning = FALSE, messages = FALSE}
suppressPackageStartupMessages({
  ### Tidyverse Collection -----------------------------------------------------
  # The tidyverse is an opinionated collection of R packages designed for
  # data science. All packages share an underlying design philosophy, grammar,
  # and data structures.
  ### https://www.tidyverse.org/
  library(tidyverse)
  
  
  
  ### Data Exploration ---------------------------------------------------------
  # To easily display summary statistics
  ### https://github.com/ropensci/skimr
  library(skimr)
  
  
  
  ### Data Cleaning/Wrangling --------------------------------------------------
  # To easily examine and clean dirty data
  ### https://www.rdocumentation.org/packages/janitor/versions/2.2.0
  library(janitor)
  
  # To easily use date-time data
  ### https://lubridate.tidyverse.org/
  library(lubridate)
  
  # To easily handle categorical variables using factors.
  ### https://forcats.tidyverse.org/
  library(forcats)
  
  
  
  ### Data Visualisation -------------------------------------------------------
  # To easily use already-made themes for data visualisation
  ### https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/
  library(ggthemes)
  
  # To combine a scatter plot and a 2D density plot
  ### https://github.com/LKremer/ggpointdensity
  library(ggpointdensity)
  
  
  
  ### Spatial Visualisation ----------------------------------------------------
  # To easily manipulate spatial data
  ### https://r-spatial.github.io/sf/
  library(sf)
  
  # This may take a little while to install if you don't have absmapsdata already.
  # Whilst I'm only using one shapefile from the package, I thought acquiring
  # the data through a package would be more standardised/reproducible than
  # downloading it straight from the ABS.
  options(timeout = 1000)
  devtools::install_github("wfmackey/absmapsdata")
  # To easily access the Australian Bureau of Statistics (ABS) spatial structures
  ### https://github.com/wfmackey/absmapsdata
  library(absmapsdata)
  
  # To easily interact spatial data and ggplot2
  ### https://paleolimbot.github.io/ggspatial/
  library(ggspatial)
  
  
  
  ### Misc ---------------------------------------------------------------------
  # To easily standardise naming conventions based upon a consistent design
  # philosophy
  ### https://github.com/Tazinho/snakecase
  library(snakecase)
  
  # To locate and download species observations from the Atlas of Living
  # Australia
  ### https://galah.ala.org.au/
  library(galah)
  
  # To easily enable file referencing in project-oriented workflows
  ### https://here.r-lib.org/
  library(here)
})
```

## **Data Loading and Sanity Checks**

Packages are all loaded in! Let's read in a specific invasive animal species for a particular state and do some sanity checks. Ideally, we will functionalise this code to do this sanity checks on all the invasive animal species that we end up choosing for each state. Arguably, this data cleaning could be a package/RShiny dashboard in of itself!

The following code is mainly reused and inspired by the [ALA Labs - An exploration of dingo observations in the ALA](https://labs.ala.org.au/posts/2023-05-16_dingoes/post.html).

First, let's log into the Atlas of Australia using the `galah_config()` function.

```{r}
# Ref [1]
# Use an Atlas of Australia-registered email (Register at ala.org.au)
galah_config(email = "johann.wagner@gmail.com")

# References:
# - [1] https://labs.ala.org.au/posts/2023-05-16_dingoes/post.html
```

### Rabbits in the ACT
Let's focus on exploring rabbits in the ACT. We will scale to other species and other states/territories later.

```{r}
# Ref [1, 4]
# To download data from the ALA
rabbits <- galah_call() %>%
  
  # To conduct a search for the scientific name of the European Rabbit
  galah_identify("oryctolagus cuniculus") %>% # Ref [2]
  
  # Filter records observed in the ACT
  galah_filter(cl22 == "Australian Capital Territory") %>% 
  
  # Pre-applied filter to ensure quality-assured data
  # the "ALA" profile is designed to exclude lower quality records Ref [3]
  galah_apply_profile(ALA) %>% 
  atlas_occurrences()

rabbits



# References:
# - [1] https://labs.ala.org.au/posts/2023-05-16_dingoes/post.html
# - [2] https://bie.ala.org.au/species/https://biodiversity.org.au/afd/taxa/692effa3-b719-495f-a86f-ce89e2981652
# - [3] https://galah.ala.org.au/R/reference/galah_apply_profile.html
# - [4] https://galah.ala.org.au/R/reference/galah.html
```

Let's use the `skim()` function to explore this dataset.

```{r}
skim(rabbits)
```

Interestingly, it seems that there are two unique `scientificName`, this is unexpected. Similarly, there are also two unique values for `taxonConceptID`. There are 1861 occurrences of rabbits in the ACT from 9 different data providers (`dataResourceName`). The most recent observation is `r rabbits$eventDate %>% max()` and the earliest is `r rabbits$eventDate %>% min()`. All the observations have longitude and latitude values, we will plot these visually in a moment to ensure they are all in the ACT.

It will be good to create a function that checks that each observation is within the spatial boundaries of each respective state/territory. 

#### Potential dodgy rabbit data
Let's explore what the two unique `scientificName` values are.

```{r}
rabbits %>% 
  group_by(scientificName) %>% 
  count()
```

Oh wow! This is our first data cleaning pick up! Even with the pre-applied ALA filter we have found an error in one of the values in `scientificName`. 
Let's find that specific data point.

```{r}
rabbits %>% 
  filter(scientificName == "Oryctolagus cuniculus cuniculus")
```

#### Create suspicious data
Looking at the `taxonConceptID` values/websites. The "Oryctolagus cuniculus cuniculus" is actually a subspecies, not a typo! Now, that we know it is a subspecies and not a typo, let's note this value down in our `suspicious_data` dataset and reassess later, but keep it in our `rabbits` dataset.

```{r}
# Let's reuse the same columns/column names as in rabbits
rabbits_suspicious <- rabbits %>% 
  filter(recordID == FALSE) %>% 
  mutate(
    suspicious_notes = character(),
    date             = character()
    ) %>% 
  
  # Add the suspicious data
  add_row({
    rabbits %>% 
      filter(scientificName == "Oryctolagus cuniculus cuniculus") %>% 
      mutate(
        suspicious_notes = "This is a subspecies of the Oryctolagus cuniculus species and is the only one in the ACT.",
        date = "2023-10-05"
        )
  })

rabbits_suspicious
```
This suspicious data point is from the [*iNaturalist Australia*](https://inaturalist.ala.org.au/) data provider, which is a Citizen Science project, so potentially more cautious investigation should go into these observations. Let's continue onto the spatial visualisation.

#### Spatial visualisation of rabbits in the ACT

Let's visualise the rabbits data spatially by creating a map with data points of the observations.

```{r}
# Ref [1]: Create spatial visualisation of the ACT
state2021 %>% 
  filter(state_name_2021 == "Australian Capital Territory") %>% 
  ggplot() +
  
  # Ref [1]: Create background polygon of the ACT
  geom_sf(
    aes(geometry = geometry)
  ) +
  
  geom_point(
    data = rabbits,
    aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    alpha = 0.6
  ) +
  
  coord_sf() +
  
  theme_minimal()



# References:
# - [1] https://github.com/wfmackey/absmapsdata/tree/master
```

Interestingly, it seems like there are a select number of observations outside of the ACT borders, which I assume is Jervis Bay territory. Let's spatially isolate these data points and see if they really are in the Jervis Bay territory.

```{r}
# Ref [1]: Create spatial visualisation of the ACT
state2021 %>% 
  filter(state_name_2021 == "Australian Capital Territory") %>% 
  ggplot() +
  
  # Ref [1]: Create background polygon of the ACT
  geom_sf(
    aes(geometry = geometry)
  ) +
  
  # Plot the Jervis Bay polygon
  geom_sf(
    data = {
      suburb2021 %>%
        filter(suburb_name_2021 == "Jervis Bay")
      },
    aes(geometry = geometry)
  ) +
  
  geom_point(
    data = rabbits,
    aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    alpha = 0.6
  ) +
  
  coord_sf() +
  
  theme_minimal()



# References:
# - [1] https://github.com/wfmackey/absmapsdata/tree/master
```

Hypothesis has been confirmed! The data points are from the Jervis Bay territory. 

#### Exclusion of Jervis Bay territory data
For the sake/scope of this assignment, we will put these data points into the ` excluded_data` dataset and remove these from our main dataset. Because I really only want to showcase observations in the main state/territory borders, as this RShiny Dashboard tool should be used for macro-scale, not small territories.

Let's create an `sf` data type so that we can use the `st_filter()` function, which filters the spatial data points within a given spatial polygon. In our case, we only want to include the data points that are within the ACT border boundary polygon.

```{r}
rabbits_sf_clean <- rabbits %>% 
  
  # Ref [1]: Convert rabbits tibble into an sf data type
  st_as_sf(
    coords = c("decimalLongitude", "decimalLatitude"),
    crs = "+proj=longlat +datum=WGS84"
  ) %>% 
  
  # Ref [2]: Filter the data points that are within the ACT
    st_filter({
      state2021 %>% 
    filter(state_name_2021 == "Australian Capital Territory")}
    )

rabbits_sf_clean


# References:
# - [1] https://stackoverflow.com/a/52951856/22410914
# - [2] https://rdrr.io/cran/sf/man/st_as_sf.html
```
We've now filtered out the excluded data points; however, we want to keep using the `tibble` data type, so let's do some joins.

```{r}
rabbits_clean <- rabbits %>% 
  
  # Find all the clean observations
  right_join(
    rabbits_sf_clean,
    join_by(
      eventDate,
      scientificName,
      taxonConceptID,
      recordID,
      dataResourceName,
      occurrenceStatus
      )
    )

rabbits_clean
```

This is now the clean rabbits dataset for the ACT.

Let's look at the excluded datasets.

```{r}
rabbits_excluded <- rabbits %>% 
  
  # Find all the excluded observations
  anti_join(
    rabbits_sf_clean,
    join_by(
      eventDate,
      scientificName,
      taxonConceptID,
      recordID,
      dataResourceName,
      occurrenceStatus
      )
    )

rabbits_excluded
```

Let's plot these points just for sanity checks.

```{r}
# Ref [1]: Create spatial visualisation of the ACT
state2021 %>% 
  filter(state_name_2021 == "Australian Capital Territory") %>% 
  ggplot() +
  
  # Ref [1]: Create background polygon of the ACT
  geom_sf(
    aes(geometry = geometry)
  ) +
  
  # Plot the Jervis Bay polygon
  geom_sf(
    data = {
      suburb2021 %>%
        filter(suburb_name_2021 == "Jervis Bay")
      },
    aes(geometry = geometry)
  ) +
  
  geom_point(
    data = rabbits_excluded,
    aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    alpha = 0.6
  ) +
  
  coord_sf() +
  
  theme_minimal() +
  
  labs(title = "Excluded Data Points")



# References:
# - [1] https://github.com/wfmackey/absmapsdata/tree/master
```

It seems like we have picked up a few extra points that seem to be just outside the ACT border boundaries. Because of the scope of the assignment, we will keep excluding all of these points. It is likely that this is either a misalignment with the ACT boundary from the ABS and the mapping data input software used by the data providers. It could also be that the borders have slightly changed in the past as the ABS boundary is the one used in 2021. There could also be an error in the GPS location data that is causing these points to be outside the ACT boundary. Regardless of the reason, due to the scope of this assignment, these points will be excluded.

#### Create excluded data

```{r}
# Let's reuse the same columns/column names as in rabbits
rabbits_excluded <- rabbits_excluded %>% 
  
  # Add excluded_notes
  mutate(
    date = "2023-10-05",
    
    excluded_notes = "These data points are outside the ABS ACT boundary. They include points that are just outside the boundary within a few kilometers and points that are in Jervis Bay"
    )

rabbits_excluded
```

#### Final Spatial Visualisation

Let's make a final spatial visualisation.

```{r}
# Ref [1]: Create spatial visualisation of the ACT
state2021 %>% 
  filter(state_name_2021 == "Australian Capital Territory") %>% 
  ggplot() +
  
  # Ref [1]: Create background polygon of the ACT
  geom_sf(
    aes(geometry = geometry)
  ) +
  
  geom_point(
    data = rabbits_clean,
    aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    alpha = 0.6
  ) +
  
  coord_sf() +
  
  theme_minimal() +
  
  # Ref [2]
  labs(title = "Rabbit observations in the ACT")



# References:
# - [1] https://github.com/wfmackey/absmapsdata/tree/master
# - [2] https://labs.ala.org.au/posts/2023-05-16_dingoes/post.html
```

## **Data Wrangling**

Create month column

# References

-   An exploration of dingo observations in the ALA https://labs.ala.org.au/posts/2023-05-16_dingoes/post.html (Accessed: 2023-10-05)
-   https://bie.ala.org.au/species/https://biodiversity.org.au/afd/taxa/692effa3-b719-495f-a86f-ce89e2981652 (Accessed: 2023-10-05)
-   https://galah.ala.org.au/R/reference/galah_apply_profile.html (Accessed: 2023-10-05)
-   https://galah.ala.org.au/R/reference/galah.html (Accessed: 2023-10-05)
-   https://github.com/wfmackey/absmapsdata/tree/master (Accessed: 2023-10-05)
-   https://inaturalist.ala.org.au/
-   https://stackoverflow.com/a/52951856/22410914
-   https://rdrr.io/cran/sf/man/st_as_sf.html